<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cesium Rocket Visualization - Red Dot</title>

  <!-- Cesium CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/cesium@1.104.0/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />
  <style>
    /* Fullscreen Cesium Canvas */
    html, body {
      margin: 0; 
      padding: 0; 
      width: 100%; 
      height: 100%;
      overflow: hidden; 
      background: #000;
    }
    #cesiumContainer {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <!-- The Cesium globe container -->
  <div id="cesiumContainer"></div>

  <!-- Socket.IO (adjust path if needed) -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- CesiumJS -->
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.104.0/Build/Cesium/Cesium.js"></script>

  <script>
  /************************************************
   *           Basic Cesium Setup
   ************************************************/
  // Insert your Ion token here
  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NDQyNDE4My1kNjkxLTQ0MDUtOWEyNC1mOTM5MTA3ZjNkNmYiLCJpZCI6MjY0Njk2LCJpYXQiOjE3MzUwNjk4OTZ9._NYeNPDjESMzfcYTEBkiR-nnPKCCDNYdt2skAjllwdM';

  const viewer = new Cesium.Viewer('cesiumContainer', {
    shouldAnimate: true,
    infoBox: false,
    selectionIndicator: false,
    timeline: false,
    animation: false,
    terrainProvider: new Cesium.EllipsoidTerrainProvider()
  });

  // Optionally hide credits
  // viewer.scene.frameState.creditDisplay.container.style.display='none';

  /************************************************
   *           Rocket Entity (Red Dot)
   ************************************************/
  // We'll keep a short trail of the last 10 updates (10 position samples).
  // Use a SampledPositionProperty for a neat real-time path.
  const rocketPositionProperty = new Cesium.SampledPositionProperty();

  // Create an entity with a red dot "point" and a path.
  const rocketEntity = viewer.entities.add({
    name: 'Rocket',
    position: rocketPositionProperty,
    // Orientation won't matter much for a dot, but you can remove or keep velocity orientation if desired:
    orientation: new Cesium.VelocityOrientationProperty(rocketPositionProperty),

    // A simple red dot
    point: {
      pixelSize: 10,
      color: Cesium.Color.RED,
      outlineColor: Cesium.Color.WHITE,
      outlineWidth: 1
    },

    // Short trailing path
    path: {
      show: true,
      leadTime: 0,
      trailTime: 999999, // We'll manually limit to the last 10 samples
      width: 3,
      material: Cesium.Color.YELLOW
    }
  });

  // Fly camera to the rocket on first data update
  let firstUpdate = true;

  /************************************************
   *          Real-time Data with Socket.IO
   ************************************************/
  const socket = io();

  // We'll store the last 10 position samples in an array
  let lastPositions = [];

  socket.on('gpsData', data => {
    const { lat, lon, altitude } = data;
    if (lat !== undefined && lon !== undefined && altitude !== undefined) {
      // Time-stamped position sample
      const now = Cesium.JulianDate.now();
      const pos = Cesium.Cartesian3.fromDegrees(lon, lat, altitude);

      rocketPositionProperty.addSample(now, pos);
      lastPositions.push({ time: now, pos });

      // Keep only the last 10
      if (lastPositions.length > 100) {
        const oldest = lastPositions.shift();
        rocketPositionProperty.removeSample(oldest.time);
      }

      // Fly once on the first update
      if (firstUpdate) {
        viewer.flyTo(rocketEntity);
        firstUpdate = false;
      }
    }
  });

  console.log('Cesium full-screen rocket visualization (red dot) ready.');
  </script>
</body>
</html>
